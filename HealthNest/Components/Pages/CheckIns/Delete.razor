@page "/checkins/delete/{id:int}"
@rendermode InteractiveServer
@using HealthNest.Data
@using HealthNest.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Identity
@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<h3>Delete Check-In</h3>

@if (checkIn == null)
{
    <p>Loading...</p>
}
else
{
    <p>Are you sure you want to delete this entry?</p>
    <button @onclick="DeleteItem">Yes, Delete</button>
    <button @onclick="HandleCancel">Cancel</button>
}

@code {
    [Parameter] public int id { get; set; }

    private CheckIn? checkIn;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        checkIn = Db.CheckIns
            .FirstOrDefault(c => c.Id == id && c.UserId == user.Id);
    }

    private async Task DeleteItem()
    {
        if (checkIn != null)
        {
            Db.CheckIns.Remove(checkIn);
            await Db.SaveChangesAsync();
        }
        Navigation.NavigateTo("/checkins");
    }

    private void HandleCancel()
    {
        Navigation.NavigateTo("/checkins");
    }
}