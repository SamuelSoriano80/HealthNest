@page "/goals"
@rendermode InteractiveServer
@using HealthNest.Data
@using HealthNest.Models
@using HealthNest.Models.Enums
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject ApplicationDbContext Db
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<div class="d-flex justify-content-between align-items-center mt-3">
    <h3>My Goals</h3>
    <a class="btn btn-success" href="/goals/create">Create New</a>
</div>

@if (goals == null)
{
    <p>Loading...</p>
}
else if (!goals.Any())
{
    <p>No goals yet.</p>
}
else
{
    <table class="table table-striped mt-2">
        <thead>
            <tr>
                <th>Category</th>
                <th>Target</th>
                <th>Period</th>
                <th>Today's Progress</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var goal in goals)
            {
                <tr>
                    <td>@goal.Category</td>
                    <td>@goal.TargetValue</td>
                    <td>@goal.Period</td>
                    <td>
                        <div class="progress" style="height:22px;">
                            <div class="progress-bar" role="progressbar"
                                 style="width:@($"{CalculateDailyProgress(goal, checkIns):0}")%"
                                 aria-valuenow="@CalculateDailyProgress(goal, checkIns)" aria-valuemin="0" aria-valuemax="100">
                                @($"{CalculateDailyProgress(goal, checkIns):0}%")
                            </div>
                        </div>
                    </td>
                    <td>@(goal.IsActive ? "Yes" : "No")</td>
                    <td>
                        <a class="btn btn-sm btn-primary me-1" href="/goals/edit/@goal.Id">Edit</a>
                        <a class="btn btn-sm btn-danger" href="/goals/delete/@goal.Id">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Goal> goals;
    private List<CheckIn> checkIns = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user == null) return;

        goals = Db.Goals
            .Where(g => g.UserId == user.Id)
            .ToList();

        checkIns = Db.CheckIns
            .Where(c => c.UserId == user.Id)
            .ToList();
    }

    private decimal CalculateDailyProgress(Goal goal, List<CheckIn> checkIns)
    {
        var today = DateOnly.FromDateTime(DateTime.Now);
        var todayCheckIn = checkIns.FirstOrDefault(c => c.Date == today);

        if (todayCheckIn == null)
            return 0;

        return goal.Category switch
        {
            GoalCategory.Sleep => todayCheckIn.SleepHours >= goal.TargetValue ? 100 : Math.Min(100,
(decimal)(todayCheckIn.SleepHours / (decimal)goal.TargetValue * 100)),
            GoalCategory.Water => todayCheckIn.WaterIntake >= goal.TargetValue ? 100 : Math.Min(100,
(decimal)todayCheckIn.WaterIntake / goal.TargetValue * 100),
            GoalCategory.Exercise => todayCheckIn.ExerciseMinutes >= goal.TargetValue ? 100 : Math.Min(100,
(decimal)todayCheckIn.ExerciseMinutes / goal.TargetValue * 100),
            _ => 0
        };
    }
}